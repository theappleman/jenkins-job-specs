---
- job:
    name: ella-parallella_linux
    scm:
    - git:
        url: https://github.com/parallella/parallella-linux
        branches:
        - '*/parallella-linux-2016.3'
        - '*/parallella-linux-2016.11'
        timeout: 600
        wipe-workspace: false
        skip-tag: true
    builders:
    - shell: |
        make ARCH=arm parallella_defconfig || make ARCH=arm multi_v7_defconfig
        make ARCH=arm CROSS_COMPILE=armv7a-hardfloat-linux-gnueabi- uImage LOADADDR=0x8000 -j8
        make ARCH=arm CROSS_COMPILE=armv7a-hardfloat-linux-gnueabi- dtbs -j8
        make ARCH=arm CROSS_COMPILE=armv7a-hardfloat-linux-gnueabi- tar-pkg -j8
    publishers:
    - archive:
        artifacts: '.config,arch/arm/boot/uImage,arch/arm/boot/dts/zynq-parallella*.dtb,linux-*-arm.tar'
        fingerprint: true

- job:
    name: ella-bitstreams-old
    disabled: true
    scm:
    - git:
        url: https://github.com/parallella/parallella-hw
        branches:
        - '*/master'
        wipe-workspace: false
        skip-tag: true
    publishers:
    - archive:
        artifacts: 'archive/fpga/old/bitstreams/*'
        fingerprint: true

- job:
    name: ella-bitstreams
    scm:
    - git:
        url: https://github.com/parallella/pubuntu
        branches:
        - '**'
        wipe-workspace: false
        skip-tag: true
    publishers:
    - archive:
        artifacts: 'fpga_bitfiles/*'
        fingerprint: true

- project:
    name: 'ella-parallella-images'
    jobs:
    - 'ella-parallella-image-{version}'
    version:
    - microserver
    - headless
    - hdmi

- job-template:
    name: 'ella-parallella-image-{version}'
    scm:
    - git:
        url: https://github.com/theappleman/armv7a-gentoo-stage4-image
        branches:
        - '*/master'
        skip-tag: true
    parameters:
    - file:
        name: ssh-keys
    builders:
    - copyartifact:
        project: ella-bitstreams
        flatten: true
    - copyartifact:
        project: ella-parallella_linux
        flatten: true
        filter: "arch/arm/boot/uImage,arch/arm/boot/dts/zynq-parallella*.dtb"
    - copyartifact:
        project: ella-esdk-2016.11
        flatten: true
    - copyartifact:
        project: ella-gentoo-stage3
        flatten: true
    - shell: |
        test -f ssh-keys && {{
            mkdir -p stage4/root/.ssh
            chmod 700 stage4/root/.ssh
            touch stage4/root/.ssh/authorized_keys
            chmod 600 stage4/root/.ssh/authorized_keys
            cp ssh-keys stage4/root/.ssh/authorized_keys
        }}
        mkdir -p stage4/opt/adapteva
        tar xf esdk.*.tar.gz -C stage4/opt/adapteva
        cp -v parallella_e16_headless_gpiose_7010.bit.bin parallella_e16_microserver_gpiose_7010.bit.bin
        cp -v zynq-parallella.dtb zynq-parallella-hdmi.dtb
        make VERSION={version}
    publishers:
    - archive:
        artifacts: parallella.img.bz2

- job:
    name: ella-gentoo-stage3
    builders:
    - shell: |
            getpath=$(wget -q -O- http://${2:-distfiles.gentoo.org}/releases/arm/autobuilds/latest-stage3-armv7a_hardfp.txt | awk 'NR==3{print$1}')
            basepath=$(basename $getpath)
            wget -c http://${2:-distfiles.gentoo.org}/releases/arm/autobuilds/$getpath
            ln -sf $basepath stage3-armv7a_hardfp-latest.tar.bz2
    publishers:
    - archive:
        artifacts: stage3-armv7a_hardfp-*.tar.bz2
        fingerprint: true

- job-template:
    name: 'ella-esdk-{branch}'
    scm:
    - git:
        url: https://github.com/theappleman/epiphany-sdk
        skip-tag: true
        branches:
        - '*/{branch}'
        basedir: sdk
    builders:
    - shell: |
        test -x ./sdk/download-components.sh && ./sdk/download-components.sh --clone || true
        test -x ./sdk/download-toolchain.sh && ./sdk/download-toolchain.sh --clone || true
        export PATH=$PATH:$PWD/builds/e-gnu/bin
        sh -x ./sdk/build-epiphany-sdk.sh -d -R -c armv7a-hardfloat-linux-gnueabi || ./sdk/build-epiphany-sdk.sh -d -c armv7a-hardfloat-linux-gnueabi -e armv7a-hardfloat-linux-gnueabi
    publishers:
    - archive:
        artifacts: 'esdk.{branch}*.tar.gz'
        fingerprint: true

- project:
    name: esdk-builds
    branch:
    - 2016.3
    - 2016.11
    jobs:
    - 'ella-esdk-{branch}'
